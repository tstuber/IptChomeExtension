/* Copyright 2011 Google Inc. All Rights Reserved. */
(function() {

  // Variables.
  var c = 0,
    d = null,
    e = null,
    f = null,
    g = null,
    h = null,
    k = null,
    m = null,
    picture = null,
    n = function(a) {
      a.target = "_blank";
      a.addEventListener("click", function() {
        window.close()
      }, !1)
    },
    // search function.
    r = function() {
      var a;
      if (a = e.value.replace(/^\s+|\s+$/g, ""))
        g.innerHTML = "Searching...",
        f.style.display = "block",
        h.style.display = "none",
        k.style.display = "none",
        m.style.display = "none",
        d.disabled = !0,
        c++,
        chrome.runtime.sendMessage({
          type: "fetch_html",
          eventKey: c,
          query: a
        }, p)
    },

    // my own search function
    r2 = function() {
      console.log("r2 hit");
      var searchTerm = e.value.replace(/^\s+|\s+$/g, "");
      var obj;

      if (searchTerm) {
        // Adjust GUI.
        g.innerHTML = "Searching.";
        f.style.display = "block";
        h.style.display = "none";
        k.style.display = "none";
        m.style.display = "none";
        picture.style.display = "none";
        // Disable the button
        // d.disabled = !0;
        c++;
        obj = lookup(searchTerm);
        backendTest();
        if (obj) {
          m.innerHTML = obj.name + ", " + obj.function;
          picture.innerHTML = "<img src='" + obj.picture + "' style='width:300px;height:225px;'>";
        } else {
          m.innerHTML = "no person found.";
          picture.innerHTML = "";
        }
        m.style.display = "block";
        picture.style.display = "block";
      }
    },
    lookup = function(searchTerm) {
      for (var i = 0; i < employees.length; i++) {
        if (employees[i].code == searchTerm) {
          return employees[i];
        }
      }
    },
    backendTest = function() {
      // Send a request to the background page, to translate the selection.
      //
      chrome.runtime.sendMessage({
        greeting: "hello"
      }, function(response) {
        if(response)
          console.log(response.farewell);
        else {
          console.log("no answer from Backend");
        }
      });
    }
  // Function to read local employee json file.
  xmlhttp = new XMLHttpRequest();
  xmlhttp.onreadystatechange = function() {
      if (this.readyState == 4 && this.status == 200) {
        employees = JSON.parse(this.responseText);
      }
    },
    // general callback function.
    p = function(a) {
      if (a.eventKey === c) {
        if (a.html) {
          m.innerHTML = a.html;
          var b = m.querySelectorAll(".audio");
          for (a = 0; a < b.length; a++) {
            var q = b[a],
              l = document.createElement("audio");
            l.a = !0;
            l.src = q.getAttribute("data-url");
            q.addEventListener("click", l.play.bind(l), !1)
          }
          b = m.querySelectorAll(".nym-link");
          for (a = 0; a < b.length; a++) b[a].addEventListener("click", function() {
            e.value = this.title ? this.title : this.innerHTML;
            r();
            return !1
          }, !1);
          b = m.querySelectorAll('a:not([class="nym-link"])');
          for (a = 0; a < b.length; a++) n(b[a]);
          f.style.display = "none";
          m.style.display = "block"
        } else g.innerHTML = "No definition found.", f.style.display = "block",
          h.href = "https://www.google.com/search?q=" + a.sanitizedQuery, h.innerHTML = 'Search the web for "' + a.sanitizedQuery + '" &raquo;', h.style.display = "block";
        d.disabled = !1
      }
    },
    d = document.getElementById("define-btn"),
    e = document.getElementById("query-field"),
    f = document.getElementById("status-box"),
    g = document.getElementById("status-msg"),
    h = document.getElementById("status-search-link"),
    k = document.getElementById("usage-tip"),
    m = document.getElementById("meaning"),
    picture = document.getElementById("picture");

  // Actions.
  k.display = "block";
  k.innerText = "Tip: Select text on any webpage, then click the Google Dictionary button to view the definition of your selection.";
  document.getElementById("year").innerText = (new Date).getFullYear();
  n(h);
  n(document.getElementById("options-link"));
  e.focus();

  // EventListener for button-click event.
  d.addEventListener("click", r2, !1); // false (default), bubbling phase
  // EventListener for query-field enter key.
  e.addEventListener("keydown", function(a) {
    console.log("Click activated.");
    13 === a.keyCode && r2()
  }, !1);

  chrome.tabs.query({
    active: !0,
    currentWindow: !0
  }, function(a) {
    a.length && (console.assert(1 === a.length), chrome.tabs.sendMessage(a[0].id, {
      type: "get_selection"
    }, function(a) {
      a && a.selection && (e.value = a.selection, r())
    }))
  });

  // load json data.
  xmlhttp.open("GET", "iptEmployees.json", true);
  xmlhttp.send();

})();
